# 该文件中切片是复现Vuldetexp实验，双向切片，向量化实验word2vec+对token求和
## MSR数据集抽样样本运行时长统计

#### 1. 先对于数据集进行过滤，固定随机数种子,随机抽取2000个样本，并保存源码

> 1. 从原始数据中挑选出有漏洞样本
> 2. 重置Pdframe的index，固定种子，挑选2000个样本
> 3. 保存样本为CSV文件
> 4. 将两千个样本按照Vuln和no-vuln的形式将源码提取出来，并保存在同一个子文件夹下
>    python raw_data_preprocess.py
>    共计用时: 72.0990s

- 目的: 得到*raw*文件夹, 其中包含Vuln(漏洞文件)和PATCH(补丁文件)源代码的配对若干子文件夹

#### 2. 源码规范化，包括去注释，变量名、函数名统一命名等

> 1. 去除注释
> 2. 变量名、函数名统一命名
> 3. 规范化文件
>    python normalization.py
>    共计用时: 16.1664s
>    4000个样本，总函数长度为290967行
>    平均函数长度为: 72.7417行

- 目的: 得到*norm*文件夹, 其组织架构仍为配对子文件夹, 但源码文件已经经过规范化处理(**去注释, 变量名、函数名统一命名**)
  
#### 3. 数据生成pdgs，生成.bin文件

    python gene_dot.py -t parse
    共计用时: 2205.9199s

- 目的: 得到*bin_data*文件夹
#### 4. .bin文件转化为图数据，生成.dot文件(1-dot信息最丰富)

    python gene_dot.py
    共计用时: 999.9268s

- 目的: 得到*dot_data*文件夹
#### 5. 根据.dot图生成slice,保存四种漏洞关注点的slice和code.txt

    python gene_slices.py
    共计用时: 270.7097s
- 目的: 得到*slice_data*文件夹
#### 6. 对slices进一步处理，去重

> 1. 函数内去重
> 2. 函数间去重
> 3. 保存去重后的切片和拓扑信息
>    python colla_slice.py
>    共计用时: 63.8601s
- 目的: 得到*slices*文件夹
#### 7. 寻找漏洞函数和非漏洞函数的差异点，并给切片打标

    python label.py
    共计用时: 1.1903s

#### 8. 训练word2vec模型，得到词向量

    python word2vec.py
    共计用时: 249.7115s

#### 9. 数据集的处理与划分

    python split_dataset.py
    共计用时: 0.3991s

#### 10. 模型的训练和推理

    python main.py
    共计用时: 562.4852s(Nvidia RTX 3090 GPU 单卡训练测试)

#### 11. 模型的可解释性

    python explain.py
    共计用时: 2047.2s (训练好的模型纯推理)

#### 运行时长统计

    72.0990s + 16.1664s + 2205.9199s + 999.9268s + 270.7097s
    + 63.8601s +1.1903s + 249.7115s + 0.3991s + 562.4852s + 2047.2s
    总计:6489.668s
    平均每百行: 1.5268s (预处理+训练推理)
    平均每百行: 2.2304s (预处理+训练推理+图解释)

#### 时长分区

| 阶段       | 阶段总用时  | 累计       | 阶段平均用时(每百行) | 累计     |
|------------|-------------|------------|----------------------|----------|
| 预处理     | 3629.8722   | 3629.8722  | 1.2475               | 1.2475   |
| 训练推理   | 812.5958    | 4442.4680  | 0.2793               | 1.5268   |
| 图解释     | 2047.2000   | 6489.6680  | 0.7036               | 2.2304   |


## MSR数据集精度统计
| Model \| Dataset    | shuffle | NVD(all-974) |         |        |        | MSR(2000) |         |        |        | SARD(2000) |         |        |        |
| ------------------- | ------- | ------------ | ------- | ------ | ------ | --------- | ------- | ------ | ------ | ---------- | ------- | ------ | ------ |
|                     |         | Acc          | P       | R      | F1     | Acc       | P       | R      | F1     | Acc        | P       | R      | F1     |
| MLP                 | √       | 63.02        | 47.37   | 1.59   | 3.07   | 63.73     | 50.33   | 8.28   | 14.22  | 75.18      | 79.58   | 60.91  | 69.00  |
|                     | ×       | 63.41        | 0.00    | 0.00   | 0.00   | 64.00     | 50.00   | 11.43  | 18.60  | 75.02      | 77.94   | 62.58  | 69.42  |
| GNN                 | √       | 66.08        | 68.60   | 14.66  | 24.16  | 66.85     | 67.40   | 16.68  | 26.75  | 84.91      | 90.39   | 74.69  | 81.79  |
|                     | ×       | 66.21        | 61.62   | 20.28  | 30.52  | 65.90     | 53.81   | 37.25  | 44.03  | 84.75      | 88.22   | 76.56  | 81.98  |
| VulDetExp           | √       | 74.28        | 72.99   | 48.15  | 58.02  | 76.86     | 76.22   | 52.72  | 62.33  | 96.21      | 97.19   | 94.37  | 95.76  |
|                     | ×       | 72.98        | 66.90   | 51.78  | 58.38  | 74.72     | 66.38   | 60.33  | 63.21  | 96.47      | 96.51   | 95.67  | 96.09  |
| VulDetExp-Trans     | √       | 75.20        | 67.10   | 64.37  | 65.71  | 80.06     | 80.15   | 59.87  | 68.54  | 96.30      | 97.20   | 94.57  | 95.87  |
|                     | ×       | 76.63        | 67.53   | 69.57  | 68.54  | 78.92     | 73.13   | 65.49  | 69.10  | 96.46      | 97.05   | 95.07  | 96.05  |
| Train & Test slices |         | Train 0      | Train 1 | Test 0 | Test 1 | Train 0   | Train 1 | Test 0 | Test 1 | Train 0    | Train 1 | Test 0 | Test 1 |
|                     |         | 3898         | 2281    | 974    | 570    | 6472      | 3687    | 1618   | 922    | 21074      | 17490   | 5268   | 4372   |

